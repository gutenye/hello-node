build:
  box: node
  steps:
    - npm-install
    - npm-test

deploy:
  box: node
  steps:
  - internal/docker-push:
      repository: gutenye/hello-node
      tag: $WERCKER_GIT_COMMIT
      username: $DOCKER_USERNAME
      password: $DOCKER_PASSWORD

  # Run this to create the rc and service
  initialize:
  - kubectl:
      server: $KUBERNETES_MASTER
      username: $KUBERNETES_USERNAME
      password: $KUBERNETES_PASSWORD
      insecure-skip-tls-verify: true
      command: create -f hello.yaml

  - kubectl:
      server: $KUBERNETES_MASTER
      username: $KUBERNETES_USERNAME
      password: $KUBERNETES_PASSWORD
      insecure-skip-tls-verify: true
      command: create -f hello-service.yaml

  rolling-update:
  - kubectl:
      server: $KUBERNETES_MASTER
      username: $KUBERNETES_USERNAME
      password: $KUBERNETES_PASSWORD
      insecure-skip-tls-verify: true
      command: rolling-update hello
      image: docker.io/gutenye/hello-node:$WERCKER_GIT_COMMIT
